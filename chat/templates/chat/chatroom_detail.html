{% extends 'base.html' %}
{% load static %}
{% block content %}
{% include 'chat/includes/chat_nav.html' %}
<div class="container mx-auto min-h-screen ">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Chatroom Header -->
        <div class="bg-slate-600 border-b border-gray-200 p-4">
            <h1 class="text-3xl font-bold text-gray-300">{{ chatroom.title }}</h1>
            <p class="text-gray-100">{{ chatroom.description }}</p>
        </div>
        <!-- Messages Container -->
<div id="messages-container" 
class="h-[calc(100vh-300px)] overflow-y-auto p-4 space-y-4 bg-[url('https://w0.peakpx.com/wallpaper/744/548/HD-wallpaper-whatsapp-ma-doodle-pattern-thumbnail.jpg')] bg-cover bg-center bg-fixed"
style="background-image: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)), url('https://w0.peakpx.com/wallpaper/744/548/HD-wallpaper-whatsapp-ma-doodle-pattern-thumbnail.jpg');">
{% for message in messages %}
<div class="message-item {% if message.user == request.user %}ml-auto{% endif %} max-w-[70%]" 
    data-message-id="{{ message.id }}">
   <div class="flex items-start {% if message.user == request.user %}justify-end{% endif %}">
       <div class="flex flex-col {% if message.user == request.user %}items-end{% endif %}">
           <div class="{% if message.user == request.user %}bg-gradient-to-r from-purple-500 to-pink-500 text-white{% else %}bg-gray-100 text-gray-800{% endif %} rounded-2xl px-4 py-2 shadow-md backdrop-blur-sm bg-opacity-90">
               <div class="flex items-center gap-2 mb-1">
                   <span class="font-semibold">{{ message.user.username }}</span>
                   <span class="text-xs opacity-75">
                       {{ message.created_at|date:"g:i A" }}
                       {% if message.is_edited %}(edited){% endif %}
                   </span>
               </div>
               <p class="message-content">{{ message.content }}</p>
           </div>
           <!-- {% if message.user == request.user %}
           <div class="flex gap-2 mt-1">
               <button onclick="editMessage({{ message.id }})" class="text-xs text-gray-500 hover:text-gray-700">Edit</button>
               <button onclick="deleteMessage({{ message.id }})" class="text-xs text-gray-500 hover:text-gray-700">Delete</button>
           </div>
           {% endif %} -->
       </div>
   </div>
</div>
{% endfor %}
</div>

        <!-- Message Input -->
        <div class="border-t border-gray-200 p-4 bg-gray-50">
            <form id="message-form" method="POST" class="flex gap-2">
                {% csrf_token %}
                <input type="text" id="message-input" name="content" placeholder="Type your message..." 
                       class="flex-grow px-4 py-2 rounded-full bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <button type="submit" 
                        class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full hover:from-purple-600 hover:to-pink-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-200 ease-in-out">
                    Send
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const roomName = {{ chatroom.id }};
    const currentUser = "{{ request.user.username }}";
    const ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(
        ws_scheme + '://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    const messageForm = document.querySelector('#message-form');
    const messageInput = document.querySelector('#message-input');
    const messagesContainer = document.querySelector('#messages-container');

    let isConnected = false;

    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established');
        isConnected = true;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        isConnected = false;
    };

    chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };

    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        
        if (message && isConnected) {
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': message
            }));
            messageInput.value = '';
        } else if (!isConnected) {
            console.error('Cannot send message: WebSocket is not connected');
        }
    });

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('Received message data:', data);
        if (data.type === 'chat_message') {
            appendMessage(data);
        }
    };

    function appendMessage(data) {
        console.log('Appending message:', data);
        const isCurrentUser = data.username === currentUser;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-item ${isCurrentUser ? 'ml-auto' : ''} max-w-[70%]`;
        messageDiv.setAttribute('data-message-id', data.message_id);
        
        messageDiv.innerHTML = `
            <div class="flex items-start ${isCurrentUser ? 'justify-end' : ''}">
                <div class="flex flex-col ${isCurrentUser ? 'items-end' : ''}">
                    <div class="${isCurrentUser ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-gray-100 text-gray-800'} rounded-2xl px-4 py-2 shadow-md">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold">${data.username}</span>
                            <span class="text-xs opacity-75">
                                ${new Date(data.timestamp).toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'})}
                            </span>
                        </div>
                        <p class="message-content">${data.message}</p>
                    </div>
                    ${isCurrentUser ? `
                        <div class="flex gap-2 mt-1">
                            <button onclick="editMessage(${data.message_id})" class="text-xs text-gray-500 hover:text-gray-700">Edit</button>
                            <button onclick="deleteMessage(${data.message_id})" class="text-xs text-gray-500 hover:text-gray-700">Delete</button>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function deleteMessage(messageId) {
        if (confirm('Are you sure you want to delete this message?')) {
            fetch(`/chat/message/${messageId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }).then(response => {
                if (response.ok) {
                    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                }
            }).catch(error => {
                console.error('Error deleting message:', error);
            });
        }
    }

    function editMessage(messageId) {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (!messageElement) return;
        
        const contentElement = messageElement.querySelector('.message-content');
        const currentContent = contentElement.textContent;
        const newContent = prompt('Edit your message:', currentContent);
        
        if (newContent && newContent !== currentContent) {
            fetch(`/chat/message/${messageId}/edit/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `content=${encodeURIComponent(newContent)}`
            }).then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    contentElement.textContent = data.content;
                    // Add edited indicator if not already present
                    const timestampElement = messageElement.querySelector('.opacity-75');
                    if (!timestampElement.textContent.includes('(edited)')) {
                        timestampElement.textContent += ' (edited)';
                    }
                }
            }).catch(error => {
                console.error('Error editing message:', error);
            });
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Auto-scroll to bottom on page load
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
});
</script>
{% endblock %}